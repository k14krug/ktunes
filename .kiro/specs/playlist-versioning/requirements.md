# Requirements Document

## Introduction

This feature will implement a playlist versioning system to maintain historical versions of the KRUG FM 96.2 playlist, enabling accurate correlation between listening history and the specific playlist version that was active when tracks were played. The current system recreates the KRUG FM 96.2 playlist hourly (when recent Spotify activity is detected), which makes it impossible to correlate historical listening data with the correct playlist version. This versioning system will solve that problem by preserving playlist snapshots and providing temporal correlation capabilities.

## Requirements

### Requirement 1

**User Story:** As a system administrator, I want the system to automatically preserve playlist versions when new playlists are generated, so that historical playlist data is not lost when playlists are recreated.

#### Acceptance Criteria

1. WHEN a new KRUG FM 96.2 playlist is generated by the scheduled task THEN the system SHALL create a versioned snapshot of the previous playlist before it is overwritten
2. WHEN creating a playlist version THEN the system SHALL assign a unique version identifier and timestamp
3. WHEN the playlist generation process completes THEN the system SHALL ensure the new playlist becomes the current active version
4. WHEN playlist versioning fails THEN the system SHALL log the error but not prevent the normal playlist generation process from completing

### Requirement 2

**User Story:** As a system administrator, I want the system to maintain an optimal number of playlist versions, so that storage is managed efficiently while preserving sufficient historical data for correlation.

#### Acceptance Criteria

1. WHEN storing playlist versions THEN the system SHALL maintain at least the last 10 versions or 7 days of playlist history, whichever provides more coverage
2. WHEN the number of stored versions exceeds the retention policy THEN the system SHALL automatically clean up the oldest versions
3. WHEN cleaning up old versions THEN the system SHALL preserve any versions that are still referenced by recent listening history data
4. WHEN determining retention policy THEN the system SHALL consider both version count and time-based criteria to optimize for correlation accuracy

### Requirement 3

**User Story:** As a developer, I want a service interface to query playlist versions by time range, so that listening history correlation can find the appropriate playlist version that was active when tracks were played.

#### Acceptance Criteria

1. WHEN querying for a playlist version by timestamp THEN the system SHALL return the playlist version that was active at the specified time
2. WHEN multiple versions exist for a time period THEN the system SHALL return the version with the closest preceding timestamp
3. WHEN no playlist version exists for a requested time THEN the system SHALL return null with appropriate logging
4. WHEN querying playlist versions THEN the system SHALL support efficient lookups using indexed timestamp queries
5. WHEN a time range query is made THEN the system SHALL return all playlist versions that were active during any part of that range

### Requirement 4

**User Story:** As a developer, I want the playlist versioning system to integrate seamlessly with the existing listening history feature, so that users can see accurate playlist correlation without system disruption.

#### Acceptance Criteria

1. WHEN the listening history feature queries for playlist correlation THEN the system SHALL use the versioning system to find the correct playlist version for each played track
2. WHEN integrating with existing code THEN the system SHALL maintain backward compatibility with current playlist query interfaces
3. WHEN playlist versioning data is unavailable THEN the system SHALL gracefully fall back to the current playlist correlation method
4. WHEN updating the listening history correlation THEN the system SHALL not require changes to the user interface or user experience

### Requirement 5

**User Story:** As a system administrator, I want the playlist versioning system to handle edge cases and errors gracefully, so that the system remains stable even when versioning encounters problems.

#### Acceptance Criteria

1. WHEN the database is unavailable during versioning THEN the system SHALL queue the versioning operation for retry without blocking playlist generation
2. WHEN a playlist version is corrupted or incomplete THEN the system SHALL mark it as invalid and exclude it from correlation queries
3. WHEN storage space is limited THEN the system SHALL prioritize keeping the most recent and most frequently accessed versions
4. WHEN concurrent playlist generation occurs THEN the system SHALL handle race conditions safely using appropriate locking mechanisms
5. WHEN versioning system maintenance is required THEN the system SHALL provide administrative tools for manual version management

### Requirement 6

**User Story:** As a developer, I want comprehensive logging and monitoring for the playlist versioning system, so that issues can be diagnosed and system health can be monitored.

#### Acceptance Criteria

1. WHEN playlist versions are created THEN the system SHALL log the version creation with timestamp, track count, and version identifier
2. WHEN versions are cleaned up THEN the system SHALL log which versions were removed and why
3. WHEN correlation queries are performed THEN the system SHALL log query performance metrics and hit/miss rates
4. WHEN errors occur in the versioning system THEN the system SHALL log detailed error information including context and recovery actions taken
5. WHEN system health monitoring is performed THEN the system SHALL provide metrics on version count, storage usage, and correlation accuracy

### Requirement 7

**User Story:** As a user, I want the playlist versioning system to operate transparently without impacting system performance, so that my experience with the application remains smooth and responsive.

#### Acceptance Criteria

1. WHEN playlist versions are being created THEN the system SHALL complete the operation within 5 seconds to avoid delaying playlist generation
2. WHEN correlation queries are performed THEN the system SHALL return results within 1 second for typical listening history requests
3. WHEN the versioning system is under load THEN the system SHALL maintain response times through efficient indexing and caching strategies
4. WHEN storage cleanup occurs THEN the system SHALL perform cleanup operations during low-usage periods to minimize impact
5. WHEN the system experiences high correlation query volume THEN the system SHALL use caching to maintain performance without degrading accuracy